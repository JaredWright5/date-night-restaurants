import BaseLayout from '@/layouts/BaseLayout.astro';
import RestaurantCard from '@/components/RestaurantCard.astro';
import { restaurants, getRestaurantsByNeighborhood } from '@/data/restaurants';

export async function getStaticPaths() {
  const uniqueNeighborhoods = Array.from(new Set(restaurants.map(r => r.neighborhood)));
  const toSlug = (name: string) => name.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  return uniqueNeighborhoods.map((name) => ({
    params: { slug: toSlug(name) },
    props: { neighborhoodName: name },
  }));
}

const { neighborhoodName: providedName } = Astro.props;
const { slug } = Astro.params;

// Convert slug back to proper neighborhood name
const slugToName = (s: string) => s.replace(/-/g,' ').replace(/\b\w/g, l => l.toUpperCase());
const neighborhoodName = providedName ?? slugToName(slug);

if (!neighborhoodName) {
  return Astro.redirect('/404');
}

// Predefined neighborhood intro copy (moved out of template to avoid TS in expressions)
const intros = {
  'Beverly Hills': 'Glamour meets romance. From white-tablecloth icons to chic modern rooms, Beverly Hills elevates every date night.',
  'West Hollywood': 'Trendy, vibrant, and stylish—WeHo blends creative cuisine with lively energy perfect for a flirty evening out.',
  'Santa Monica': 'Ocean breezes, sunset views, and coastal charm create effortlessly romantic nights by the beach.',
  'Venice': 'Bohemian spirit and creative kitchens—Venice is ideal for couples who love character and conversation.',
  'Downtown LA': 'Rooftops, modern tasting menus, and skyline views make DTLA a dramatic stage for big nights.',
  'Hollywood': 'Classic LA allure with intimate hideaways and iconic settings for cinematic romance.',
  'Silver Lake': 'Hip, cozy, and culinary-forward—Silver Lake shines for low-key, high-quality dates.',
  'Los Feliz': 'Charming streets and warm neighborhood gems set the tone for relaxed romance.',
  'Manhattan Beach': 'Seafood, sunsets, and sophisticated casual—MB is coastal romance at its best.',
  'Pasadena': 'Historic elegance and refined dining rooms perfect for timeless celebrations.'
};

const neighborhoodRestaurants = getRestaurantsByNeighborhood(neighborhoodName);
const topRestaurants = neighborhoodRestaurants
  .sort((a, b) => b.dateNightScore - a.dateNightScore)
  .slice(0, 6);

const avgRating = neighborhoodRestaurants.length > 0 
  ? (neighborhoodRestaurants.reduce((sum, r) => sum + r.rating, 0) / neighborhoodRestaurants.length).toFixed(1)
  : 0;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "Place",
  "name": `${neighborhoodName} Date Night Restaurants`,
  "description": `Discover the best romantic restaurants in ${neighborhoodName}, Los Angeles. ${neighborhoodRestaurants.length} handpicked date night dining spots.`,
  "url": `https://datenightrestaurants.com/neighborhoods/${slug}/`,
  "containedInPlace": {
    "@type": "City",
    "name": "Los Angeles",
    "containedInPlace": {
      "@type": "State",
      "name": "California"
    }
  },
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": neighborhoodRestaurants.length,
    "itemListElement": neighborhoodRestaurants.slice(0, 10).map((restaurant, index) => ({
      "@type": "Restaurant",
      "position": index + 1,
      "name": restaurant.name,
      "address": restaurant.address,
      "telephone": restaurant.phone,
      "url": restaurant.website,
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": restaurant.rating,
        "reviewCount": restaurant.reviews.length
      }
    }))
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {"@type": "ListItem", "position": 1, "name": "Home", "item": "https://datenightrestaurants.com/"},
      {"@type": "ListItem", "position": 2, "name": "Neighborhoods", "item": "https://datenightrestaurants.com/neighborhoods/"},
      {"@type": "ListItem", "position": 3, "name": `${neighborhoodName}`, "item": `https://datenightrestaurants.com/neighborhoods/${slug}/`}
    ]
  }
};
---

<BaseLayout 
  title={`Date Night Restaurants in ${neighborhoodName} | Los Angeles | Date Night Restaurants`}
  description={`Discover the best romantic restaurants in ${neighborhoodName}, Los Angeles. ${neighborhoodRestaurants.length} handpicked date night dining spots with reviews, photos, and reservations.`}
  keywords={[`date night restaurants ${neighborhoodName}`, `romantic dining ${neighborhoodName}`, `couples restaurants ${neighborhoodName}`, `fine dining ${neighborhoodName}`]}
  canonical={`https://datenightrestaurants.com/neighborhoods/${slug}/`}
  structuredData={structuredData}
>
  <!-- Neighborhood Hero -->
  <section class="neighborhood-hero">
    <div class="neighborhood-hero-content">
      <nav class="breadcrumbs"><a href="/">Home</a> / <a href="/neighborhoods/">Neighborhoods</a> / <span>{neighborhoodName}</span></nav>
      <h1>Date Night Restaurants in {neighborhoodName}</h1>
      <p class="neighborhood-description">{intros[neighborhoodName] ?? `Discover the most romantic dining experiences in ${neighborhoodName}, Los Angeles.`}</p>
      
      <div class="neighborhood-stats">
        <div class="stat">
          <span class="stat-number">{neighborhoodRestaurants.length}</span>
          <span class="stat-label">Restaurants</span>
        </div>
        <div class="stat">
          <span class="stat-number">{avgRating}★</span>
          <span class="stat-label">Average Rating</span>
        </div>
        <div class="stat">
          <span class="stat-number">{neighborhoodRestaurants.filter(r => r.priceLevel >= 3).length}</span>
          <span class="stat-label">Fine Dining</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Top Restaurants -->
  <section class="top-restaurants">
    <div class="container">
      <h2>Top Date Night Restaurants in {neighborhoodName}</h2>
      <p>Handpicked romantic dining experiences in {neighborhoodName}</p>
      
      {topRestaurants.length > 0 ? (
        <div class="restaurants-grid">
          {topRestaurants.map(restaurant => (
            <RestaurantCard restaurant={restaurant} />
          ))}
        </div>
      ) : (
        <div class="no-restaurants">
          <h3>Coming Soon!</h3>
          <p>We're working on adding the best date night restaurants in {neighborhoodName}. Check back soon!</p>
        </div>
      )}
      
      {neighborhoodRestaurants.length > 6 && (
        <div class="section-actions">
          <a href={`/neighborhoods/${slug}/restaurants/`} class="btn btn-primary">
            View All {neighborhoodRestaurants.length} Restaurants
          </a>
        </div>
      )}

      {topRestaurants.length > 0 && (
        <div class="why-we-love">
          <h3>Why We Love These Picks</h3>
          <ul>
            {topRestaurants.slice(0,3).map(r => (
              <li>
                <strong>{r.name}</strong> —
                {r.cuisineTypes.includes('rooftop_restaurant') ? ' breathtaking views and golden-hour ambiance' : ''}
                {r.cuisineTypes.includes('italian_restaurant') ? ' handmade pasta and candlelit romance' : ''}
                {r.cuisineTypes.includes('french_restaurant') ? ' refined French technique in an intimate room' : ''}
                {(!r.cuisineTypes.includes('rooftop_restaurant') && !r.cuisineTypes.includes('italian_restaurant') && !r.cuisineTypes.includes('french_restaurant')) ? ' exceptional cooking with true date-night atmosphere' : ''}
                {r.priceLevel >= 3 ? ' with upscale service for special occasions' : ' with a relaxed vibe ideal for conversation'}
                {r.rating >= 4.6 ? ' and consistently stellar diner reviews.' : '.'}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </section>

  <!-- Neighborhood Info -->
  <section class="neighborhood-info">
    <div class="container">
      <div class="info-grid">
        <div class="info-section">
          <h3>About {neighborhoodName}</h3>
          <p>
            {neighborhoodName} offers some of the most romantic dining experiences in Los Angeles. 
            From intimate wine bars to fine dining establishments, this neighborhood has something 
            special for every couple looking for the perfect date night.
          </p>
          <div class="neighborhood-details">
            <p><strong>Location:</strong> Los Angeles, California</p>
            <p><strong>Restaurants:</strong> {neighborhoodRestaurants.length}</p>
            <p><strong>Average Rating:</strong> {avgRating}/5</p>
          </div>
        </div>
        
        <div class="info-section">
          <h3>Popular Cuisines</h3>
          <div class="cuisines-list">
            {(() => {
              const seen = Array.from(new Set(neighborhoodRestaurants.flatMap(r => r.cuisineTypes))).slice(0, 6);
              const capitalizeWords = (s) => s.replace(/_/g, ' ').replace(/\b\w/g, (ch) => ch.toUpperCase());
              return seen.map((cuisine) => (
                <span class="cuisine-tag">{capitalizeWords(cuisine)}</span>
              ));
            })()}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Neighborhoods -->
  <section class="related-neighborhoods">
    <div class="container">
      <h2>Explore Other Neighborhoods</h2>
      <div class="neighborhoods-grid">
        {(() => {
          const otherNeighborhoods = ['Beverly Hills', 'Santa Monica', 'West Hollywood', 'Venice', 'Hollywood', 'Silver Lake']
            .filter(n => n !== neighborhoodName)
            .slice(0, 4);
          return otherNeighborhoods.map(otherNeighborhood => {
            const otherRestaurants = getRestaurantsByNeighborhood(otherNeighborhood);
            const otherSlug = otherNeighborhood.toLowerCase().replace(/\s+/g, '-');
            return (
              <div class="neighborhood-card">
                <a href={`/neighborhoods/${otherSlug}/`}>
                  <h3>{otherNeighborhood}</h3>
                  <p>{otherRestaurants.length} restaurants</p>
                  <div class="neighborhood-rating">
                    <span class="stars">{'★'.repeat(Math.floor(avgRating))}</span>
                    <span class="rating">{avgRating}</span>
                  </div>
                </a>
              </div>
            );
          });
        })()}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .neighborhood-hero {
    background: linear-gradient(135deg, #2C2C2C 0%, #4A4A4A 50%, #D4AF37 100%);
    color: white;
    padding: 120px 0 80px;
    text-align: center;
  }
  
  .neighborhood-hero-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  
  .neighborhood-hero h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    font-weight: 700;
  }
  
  .neighborhood-description {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    opacity: 0.9;
  }
  
  .neighborhood-stats {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-top: 2rem;
  }
  
  .stat {
    text-align: center;
  }
  
  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
  }
  
  .stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
  }
  
  .top-restaurants {
    padding: 80px 0;
    background: #fff;
  }
  
  .top-restaurants h2 {
    text-align: center;
    margin-bottom: 1rem;
    color: #333;
  }
  
  .top-restaurants p {
    text-align: center;
    margin-bottom: 3rem;
    color: #666;
  }
  
  .restaurants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }
  
  .no-restaurants {
    text-align: center;
    padding: 4rem 2rem;
    background: #f8f9fa;
    border-radius: 15px;
  }
  
  .no-restaurants h3 {
    color: #333;
    margin-bottom: 1rem;
  }
  
  .no-restaurants p {
    color: #666;
  }
  
  .section-actions {
    text-align: center;
  }
  
  .btn {
    display: inline-block;
    padding: 1rem 2rem;
    background: #D4AF37;
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn:hover {
    background: #6B1A2F;
    transform: translateY(-2px);
  }
  
  .neighborhood-info {
    padding: 80px 0;
    background: #f8f9fa;
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
  }
  
  .info-section {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
  }
  
  .info-section h3 {
    color: #333;
    margin-bottom: 1rem;
  }
  
  .info-section p {
    color: #666;
    line-height: 1.6;
    margin-bottom: 1rem;
  }
  
  .neighborhood-details p {
    margin-bottom: 0.5rem;
  }
  
  .cuisines-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .cuisine-tag {
    background: #D4AF37;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  
  .related-neighborhoods {
    padding: 80px 0;
    background: #fff;
  }
  
  .related-neighborhoods h2 {
    text-align: center;
    margin-bottom: 3rem;
    color: #333;
  }
  
  .neighborhoods-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }
  
  .neighborhood-card {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    transition: transform 0.3s ease;
  }
  
  .neighborhood-card:hover {
    transform: translateY(-5px);
  }
  
  .neighborhood-card a {
    text-decoration: none;
    color: inherit;
  }
  
  .neighborhood-card h3 {
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .neighborhood-card p {
    color: #666;
    margin-bottom: 0.5rem;
  }
  
  .neighborhood-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .neighborhood-rating .stars {
    color: #D4AF37;
    font-size: 1.1rem;
  }
  
  .neighborhood-rating .rating {
    color: #666;
    font-weight: 600;
  }
  
  @media (max-width: 768px) {
    .neighborhood-hero h1 {
      font-size: 2.5rem;
    }
    
    .neighborhood-stats {
      flex-direction: column;
      gap: 1rem;
    }
    
    .restaurants-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
