---
import BaseLayout from '@/layouts/BaseLayout.astro';
import RestaurantCard from '@/components/RestaurantCard.astro';
import { getRestaurantBySlug, searchRestaurants, generateDateNightDescription } from '@/data/restaurants';
import { getAllCities } from '@/data/cities';

export async function getStaticPaths() {
  const { restaurants } = await import('@/data/restaurants');
  return restaurants.map((restaurant) => ({
    params: { restaurant: restaurant.slug },
    props: { restaurant },
  }));
}

const { restaurant } = Astro.props;
const { restaurant: restaurantSlug } = Astro.params;

if (!restaurant) {
  return Astro.redirect('/404');
}

// Ensure restaurant has required properties
if (!restaurant.name || !restaurant.slug) {
  return Astro.redirect('/404');
}

const relatedRestaurants = searchRestaurants('', { cuisine: restaurant.cuisineTypes[0] })
  .filter(r => r.id !== restaurant.id)
  .slice(0, 4);

const priceSymbols = '$'.repeat(restaurant.priceLevel);
const stars = '★'.repeat(Math.floor(restaurant.rating));
const mainImage = restaurant.photos[0] || 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&h=600&fit=crop';
const dateNightDescription = generateDateNightDescription(restaurant);

const structuredData = {
  "@context": "https://schema.org",
  "@type": "Restaurant",
  "name": restaurant.name,
  "description": dateNightDescription,
  "url": `https://datenightrestaurants.com/losangeles/${restaurant.slug}/`,
  "telephone": restaurant.phone,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": restaurant.address,
    "addressLocality": restaurant.area,
    "addressRegion": "CA",
    "postalCode": restaurant.zipCode,
    "addressCountry": "US"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": restaurant.latitude,
    "longitude": restaurant.longitude
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": restaurant.rating || 0,
    "reviewCount": restaurant.reviews?.length || 0
  },
  "priceRange": priceSymbols,
  "servesCuisine": restaurant.cuisineTypes,
  "openingHoursSpecification": Object.entries(restaurant.openingHours || {}).map(([day, hours]) => {
    if (!hours || typeof hours !== 'string') return null;
    const timeParts = hours.split('–');
    if (timeParts.length !== 2) return null;
    return {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": day,
      "opens": timeParts[0].trim(),
      "closes": timeParts[1].trim()
    };
  }).filter(Boolean),
  "image": restaurant.photos,
  "sameAs": restaurant.website
};
---

<BaseLayout 
  title={`${restaurant.name} | Date Night Restaurant in ${restaurant.area} | Date Night Restaurants`}
  description={dateNightDescription}
  keywords={[restaurant.name, `date night restaurant ${restaurant.area}`, `romantic dining ${restaurant.area}`, ...restaurant.cuisineTypes, `fine dining ${restaurant.area}`]}
  canonical={`https://datenightrestaurants.com/losangeles/${restaurant.slug}/`}
  ogImage={mainImage}
  structuredData={structuredData}
>
  <!-- Restaurant Hero -->
  <section class="restaurant-hero">
    <div class="restaurant-hero-content">
      <div class="restaurant-hero-image">
        <img src={mainImage} alt={restaurant.name} />
      </div>
      <div class="restaurant-hero-info">
        <h1>{restaurant.name}</h1>
        <div class="restaurant-meta">
          <div class="restaurant-rating">
            <span class="stars">{stars}</span>
            <span>{restaurant.rating}/5</span>
          </div>
          <div class="restaurant-price">{priceSymbols}</div>
          <div class="restaurant-score">Date Score: {restaurant.dateNightScore}</div>
        </div>
        <div class="restaurant-description">
          <h3>Perfect for Date Nights</h3>
          <p>{dateNightDescription}</p>
        </div>
        <div class="restaurant-actions">
          <a href={restaurant.website} target="_blank" class="btn btn-primary">
            <i class="fas fa-external-link-alt"></i> Visit Website
          </a>
          <a href={`tel:${restaurant.phone}`} class="btn btn-secondary">
            <i class="fas fa-phone"></i> Call Now
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Restaurant Details -->
  <section class="restaurant-details">
    <div class="container">
      <div class="details-grid">
        <div class="details-section">
          <h3><i class="fas fa-map-marker-alt"></i> Location & Contact</h3>
          <div class="contact-info">
            <p><strong>Address:</strong> {restaurant.address}</p>
            <p><strong>Phone:</strong> <a href={`tel:${restaurant.phone}`}>{restaurant.phone}</a></p>
            <p><strong>Website:</strong> <a href={restaurant.website} target="_blank">{restaurant.website}</a></p>
            <p><strong>Cuisine:</strong> {restaurant.cuisineTypes.join(', ')}</p>
            <p><strong>Area:</strong> {restaurant.area}</p>
          </div>
          <div class="map-placeholder">
            {/* Placeholder for a map component */}
            <img src={`https://maps.googleapis.com/maps/api/staticmap?center=${restaurant.latitude},${restaurant.longitude}&zoom=14&size=600x300&markers=color:red%7C${restaurant.latitude},${restaurant.longitude}&key=YOUR_GOOGLE_MAPS_API_KEY`} alt="Map location" />
          </div>
        </div>
        <div class="details-section">
          <h3><i class="fas fa-clock"></i> Opening Hours</h3>
          <ul class="opening-hours">
            {Object.entries(restaurant.openingHours || {}).map(([day, hours]) => (
              <li><strong>{day}:</strong> {hours || 'Closed'}</li>
            ))}
          </ul>
        </div>
        <div class="details-section">
          <h3><i class="fas fa-star"></i> Reviews ({restaurant.reviews?.length || 0})</h3>
          <div class="reviews-list">
            {(restaurant.reviews || []).slice(0, 3).map(review => (
              <div class="review-item">
                <p class="review-author"><strong>{review.author || 'Anonymous'}</strong> - {review.rating || 'N/A'}★</p>
                <p class="review-text">{review.text || 'No review text available'}</p>
              </div>
            ))}
            {(restaurant.reviews?.length || 0) > 3 && (
              <p class="more-reviews">And {(restaurant.reviews?.length || 0) - 3} more reviews...</p>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Photo Gallery -->
  {restaurant.photos && restaurant.photos.length > 1 && (
    <section class="photo-gallery">
      <div class="container">
        <h2>Photo Gallery</h2>
        <div class="gallery-grid">
          {restaurant.photos.slice(1).map(photo => (
            <div class="gallery-item">
              <img src={photo} alt={restaurant.name} loading="lazy" />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Related Restaurants -->
  {relatedRestaurants.length > 0 && (
    <section class="related-restaurants">
      <div class="container">
        <h2>More Romantic Spots Near {restaurant.area}</h2>
        <div class="restaurants-grid">
          {relatedRestaurants.map(r => (
            <RestaurantCard restaurant={r} showDateScore={false} />
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .restaurant-hero {
    background: linear-gradient(135deg, #2C2C2C 0%, #4A4A4A 50%, #D4AF37 100%);
    color: white;
    padding: 120px 0 80px;
  }
  
  .restaurant-hero-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 3rem;
  }
  
  .restaurant-hero-image {
    flex: 1;
    min-width: 400px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  .restaurant-hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  .restaurant-hero-info {
    flex: 1.5;
  }
  
  .restaurant-hero-info h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    font-family: 'Playfair Display', serif;
  }
  
  .restaurant-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  
  .restaurant-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .restaurant-rating .stars {
    color: #ffc107;
  }
  
  .restaurant-price {
    background: #D4AF37;
    color: #2C2C2C;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .restaurant-score {
    background: #4A4A4A;
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .restaurant-description {
    background: #F8F6F0;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border-left: 4px solid #D4AF37;
  }
  
  .restaurant-description h3 {
    color: #2C2C2C;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .restaurant-description p {
    color: #4A4A4A;
    line-height: 1.7;
    margin: 0;
    font-size: 1rem;
  }
  
  .restaurant-actions {
    display: flex;
    gap: 1rem;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-primary {
    background: #D4AF37;
    color: #2C2C2C;
  }
  
  .btn-primary:hover {
    background: #B8941F;
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    background: #F8F6F0;
    color: #4A4A4A;
    border: 1px solid #E8D5B7;
  }
  
  .btn-secondary:hover {
    background: #F0EDE5;
    transform: translateY(-2px);
  }
  
  .restaurant-details {
    padding: 4rem 0;
  }
  
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 3rem;
  }
  
  .details-section h3 {
    font-size: 1.5rem;
    color: #2C2C2C;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Playfair Display', serif;
  }
  
  .details-section h3 i {
    color: #D4AF37;
  }
  
  .contact-info p {
    margin-bottom: 0.5rem;
    color: #4A4A4A;
  }
  
  .contact-info a {
    color: #D4AF37;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  
  .contact-info a:hover {
    color: #B8941F;
  }
  
  .map-placeholder {
    background: #e0e0e0;
    height: 200px;
    border-radius: 10px;
    margin-top: 1.5rem;
    overflow: hidden;
  }

  .map-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .opening-hours {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .opening-hours li {
    margin-bottom: 0.5rem;
    color: #4A4A4A;
  }
  
  .reviews-list {
    margin-top: 1rem;
  }
  
  .review-item {
    background: #F8F6F0;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    border-left: 3px solid #8B9A8B;
  }
  
  .review-author {
    font-weight: 600;
    color: #2C2C2C;
    margin-bottom: 0.5rem;
  }
  
  .review-text {
    color: #4A4A4A;
    line-height: 1.6;
  }
  
  .more-reviews {
    text-align: center;
    margin-top: 1.5rem;
    color: #6B7B7B;
  }
  
  .photo-gallery {
    padding: 4rem 0;
    background: #F8F6F0;
    text-align: center;
  }
  
  .photo-gallery h2 {
    font-size: 2.5rem;
    color: #2C2C2C;
    margin-bottom: 2rem;
    font-family: 'Playfair Display', serif;
  }
  
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .gallery-item {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .gallery-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }
  
  .related-restaurants {
    padding: 4rem 0;
    text-align: center;
  }
  
  .related-restaurants h2 {
    font-size: 2.5rem;
    color: #2C2C2C;
    margin-bottom: 2rem;
    font-family: 'Playfair Display', serif;
  }
  
  @media (max-width: 768px) {
    .restaurant-hero-content {
      flex-direction: column;
      text-align: center;
    }
    
    .restaurant-hero-image {
      min-width: unset;
      width: 100%;
    }
    
    .restaurant-hero-info h1 {
      font-size: 2.5rem;
    }
    
    .restaurant-meta {
      justify-content: center;
    }
    
    .restaurant-actions {
      flex-direction: column;
    }
    
    .details-grid {
      grid-template-columns: 1fr;
    }
    
    .photo-gallery, .related-restaurants {
      padding: 3rem 0;
    }
    
    .photo-gallery h2, .related-restaurants h2 {
      font-size: 2rem;
    }
  }
</style>
