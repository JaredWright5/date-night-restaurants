---
import BaseLayout from '@/layouts/BaseLayout.astro';
import RestaurantCard from '@/components/RestaurantCard.astro';
import { getRestaurantBySlug, searchRestaurants } from '@/lib/supabase';

export async function getStaticPaths() {
  const { getAllRestaurants } = await import('@/lib/supabase');
  const restaurants = await getAllRestaurants();
  return restaurants.map((restaurant) => ({
    params: { restaurant: restaurant.slug },
    props: { restaurant },
  }));
}

const { restaurant } = Astro.props;
const { restaurant: restaurantSlug } = Astro.params;

if (!restaurant) {
  return Astro.redirect('/404');
}

// Ensure restaurant has required properties
if (!restaurant.name || !restaurant.slug) {
  return Astro.redirect('/404');
}

// Get related restaurants by fetching all and filtering
const { getAllRestaurants } = await import('@/lib/supabase');
const allRestaurants = await getAllRestaurants();
const relatedRestaurants = allRestaurants
  .filter(r => r.cuisine_types?.includes(restaurant.cuisine_types?.[0]) && r.id !== restaurant.id)
  .slice(0, 4);

const priceSymbols = '$'.repeat(restaurant.price_level);
const mainImage = restaurant.photos?.[0] || 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=800&h=600&fit=crop';
const dateNightDescription = `Perfect for a romantic date night with ${restaurant.cuisine_types?.join(', ') || 'excellent cuisine'} in ${restaurant.neighborhood}. ${restaurant.description || 'An intimate dining experience.'}`;

// Calculate review count from reviews array
const reviewCount = restaurant.reviews && Array.isArray(restaurant.reviews) ? restaurant.reviews.length : 0;
const hasValidRating = restaurant.rating && restaurant.rating > 0;

const structuredData: any = {
  "@context": "https://schema.org",
  "@type": "Restaurant",
  "name": restaurant.name,
  "description": dateNightDescription,
  "url": `https://datenightrestaurants.com/losangeles/${restaurant.slug}/`,
  "telephone": restaurant.phone,
  "address": {
    "@type": "PostalAddress",
    "streetAddress": restaurant.address,
    "addressLocality": restaurant.neighborhood,
    "addressRegion": "CA",
    "addressCountry": "US"
  },
  "priceRange": priceSymbols,
  "servesCuisine": restaurant.cuisine_types || [],
  "openingHoursSpecification": [],
  "image": restaurant.photos || [],
  "sameAs": restaurant.website
};

// Only include aggregateRating if we have valid reviews
if (hasValidRating && reviewCount > 0) {
  structuredData.aggregateRating = {
    "@type": "AggregateRating",
    "ratingValue": restaurant.rating,
    "reviewCount": reviewCount
  };
}
---

<BaseLayout 
  title={`${restaurant.name} | Date Night Restaurant in ${restaurant.neighborhood} | Date Night Restaurants`}
  description={dateNightDescription}
  keywords={[restaurant.name, `date night restaurant ${restaurant.neighborhood}`, `romantic dining ${restaurant.neighborhood}`, ...(restaurant.cuisine_types || []), `fine dining ${restaurant.neighborhood}`]}
  canonical={`https://datenightrestaurants.com/losangeles/${restaurant.slug}/`}
  ogImage={mainImage}
  structuredData={structuredData}
>
  <!-- Restaurant Hero -->
  <section class="restaurant-hero">
    <div class="restaurant-hero-content">
      <div class="restaurant-hero-image">
        <img src={mainImage} alt={restaurant.name} />
      </div>
      <div class="restaurant-hero-info">
        <h1>{restaurant.name}</h1>
        <div class="restaurant-meta">
          <div class="restaurant-rating">
            <div class="date-score-display">
              <i class="fas fa-heart"></i>
              <span>{restaurant.date_night_score}</span>
            </div>
          </div>
          <div class="restaurant-price">{priceSymbols}</div>
          {restaurant.date_night_score >= 90 && (
            <div class="top-rated-badge">
              <i class="fas fa-crown"></i>
              <span>Top Rated</span>
            </div>
          )}
        </div>
        <div class="restaurant-description">
          <h3>Perfect for Date Nights</h3>
          <p>{dateNightDescription}</p>
        </div>
        <div class="restaurant-actions">
          <a href={restaurant.website} target="_blank" class="btn btn-primary">
            <i class="fas fa-external-link-alt"></i> Visit Website
          </a>
          <a href={`tel:${restaurant.phone}`} class="btn btn-secondary">
            <i class="fas fa-phone"></i> Call Now
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Restaurant Details -->
  <section class="restaurant-details">
    <div class="container">
      <div class="details-grid">
        <div class="details-section">
          <h3><i class="fas fa-map-marker-alt"></i> Location & Contact</h3>
          <div class="contact-info">
            <p><strong>Address:</strong> {restaurant.address}</p>
            <p><strong>Phone:</strong> <a href={`tel:${restaurant.phone}`}>{restaurant.phone}</a></p>
            <p><strong>Website:</strong> <a href={restaurant.website} target="_blank">{restaurant.website}</a></p>
            <p><strong>Cuisine:</strong> {restaurant.cuisine_types?.map(cuisine => 
              cuisine.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            ).join(', ')}</p>
            <p><strong>Area:</strong> {restaurant.neighborhood}</p>
          </div>
          <div class="map-placeholder">
            <iframe
              src={`https://www.google.com/maps/embed/v1/place?key=${import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY || 'AIzaSyCiRZ0a28y84EHFtBufwGklkO35zRGGzkI'}&q=${encodeURIComponent(restaurant.address)}&zoom=14`}
              width="100%"
              height="300"
              style="border:0;"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>
          </div>
        </div>
        <div class="details-section">
          <h3><i class="fas fa-clock"></i> Opening Hours</h3>
          <ul class="opening-hours">
            {Object.entries(restaurant.opening_hours || {}).map(([day, hours]) => (
              <li><strong>{day}:</strong> {hours || 'Closed'}</li>
            ))}
          </ul>
        </div>
        <div class="details-section">
          <h3><i class="fas fa-star"></i> Reviews ({restaurant.reviews?.length || 0})</h3>
          <div class="reviews-list">
            {(restaurant.reviews || []).slice(0, 3).map(review => (
              <div class="review-item">
                <p class="review-author"><strong>{review.author || 'Anonymous'}</strong> - {review.rating || 'N/A'}â˜…</p>
                <p class="review-text">{review.text || 'No review text available'}</p>
              </div>
            ))}
            {(restaurant.reviews?.length || 0) > 3 && (
              <p class="more-reviews">And {(restaurant.reviews?.length || 0) - 3} more reviews...</p>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Photo Gallery -->
  {restaurant.photos && restaurant.photos.length > 1 && (
    <section class="photo-gallery">
      <div class="container">
        <h2>Photo Gallery</h2>
        <div class="gallery-grid">
          {restaurant.photos.slice(1).map(photo => (
            <div class="gallery-item">
              <img src={photo} alt={restaurant.name} loading="lazy" />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Related Restaurants -->
  {relatedRestaurants.length > 0 && (
    <section class="related-restaurants">
      <div class="container">
        <h2>More Romantic Spots Near {restaurant.neighborhood}</h2>
        <div class="restaurants-grid">
          {relatedRestaurants.map(r => (
            <RestaurantCard restaurant={r} showDateScore={false} />
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .restaurant-hero {
    background: #FFF8F0;
    color: #3E2723;
    padding: 120px 0 80px;
    border-bottom: 3px solid #E8B86D;
  }
  
  .restaurant-hero-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 3rem;
  }
  
  .restaurant-hero-image {
    flex: 1;
    min-width: 400px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  
  .restaurant-hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  .restaurant-hero-info {
    flex: 1.5;
  }
  
  .restaurant-hero-info h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    font-family: 'Playfair Display', serif;
    color: #3E2723;
  }
  
  .restaurant-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  
  .restaurant-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .date-score-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(44, 44, 44, 0.9);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .date-score-display i {
    color: #D4AF37;
  }
  
  .date-score-display span {
    color: white;
  }
  
  .top-rated-badge {
    background: linear-gradient(45deg, #D4AF37, #E6C547);
    color: #2C2C2C;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
    animation: pulse 2s infinite;
  }
  
  .top-rated-badge i {
    font-size: 1rem;
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
    }
    50% {
      box-shadow: 0 2px 20px rgba(212, 175, 55, 0.6);
    }
    100% {
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
    }
  }
  
  .restaurant-price {
    background: #D4AF37;
    color: #2C2C2C;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .restaurant-score {
    background: #4A4A4A;
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
  }
  
  .restaurant-description {
    background: #F8F6F0;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border-left: 4px solid #D4AF37;
  }
  
  .restaurant-description h3 {
    color: #2C2C2C;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .restaurant-description p {
    color: #4A4A4A;
    line-height: 1.7;
    margin: 0;
    font-size: 1rem;
  }
  
  .restaurant-actions {
    display: flex;
    gap: 1rem;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-primary {
    background: #D4AF37;
    color: #2C2C2C;
  }
  
  .btn-primary:hover {
    background: #B8941F;
    transform: translateY(-2px);
  }
  
  .btn-secondary {
    background: #F8F6F0;
    color: #4A4A4A;
    border: 1px solid #E8D5B7;
  }
  
  .btn-secondary:hover {
    background: #F0EDE5;
    transform: translateY(-2px);
  }
  
  .restaurant-details {
    padding: 4rem 0;
  }
  
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 3rem;
  }
  
  .details-section h3 {
    font-size: 1.5rem;
    color: #2C2C2C;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Playfair Display', serif;
  }
  
  .details-section h3 i {
    color: #D4AF37;
  }
  
  .contact-info p {
    margin-bottom: 0.5rem;
    color: #4A4A4A;
  }
  
  .contact-info a {
    color: #D4AF37;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  
  .contact-info a:hover {
    color: #B8941F;
  }
  
  .map-placeholder {
    background: #e0e0e0;
    height: 300px;
    border-radius: 10px;
    margin-top: 1.5rem;
    overflow: hidden;
  }

  .map-placeholder iframe {
    width: 100%;
    height: 100%;
    display: block;
  }
  
  .opening-hours {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .opening-hours li {
    margin-bottom: 0.5rem;
    color: #4A4A4A;
  }
  
  .reviews-list {
    margin-top: 1rem;
  }
  
  .review-item {
    background: #F8F6F0;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    border-left: 3px solid #8B9A8B;
  }
  
  .review-author {
    font-weight: 600;
    color: #2C2C2C;
    margin-bottom: 0.5rem;
  }
  
  .review-text {
    color: #4A4A4A;
    line-height: 1.6;
  }
  
  .more-reviews {
    text-align: center;
    margin-top: 1.5rem;
    color: #6B7B7B;
  }
  
  .photo-gallery {
    padding: 4rem 0;
    background: #F8F6F0;
    text-align: center;
  }
  
  .photo-gallery h2 {
    font-size: 2.5rem;
    color: #2C2C2C;
    margin-bottom: 2rem;
    font-family: 'Playfair Display', serif;
  }
  
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .gallery-item {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .gallery-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }
  
  .related-restaurants {
    padding: 4rem 0;
    text-align: center;
  }
  
  .related-restaurants h2 {
    font-size: 2.5rem;
    color: #2C2C2C;
    margin-bottom: 2rem;
    font-family: 'Playfair Display', serif;
  }
  
  @media (max-width: 768px) {
    .restaurant-hero-content {
      flex-direction: column;
      text-align: center;
    }
    
    .restaurant-hero-image {
      min-width: unset;
      width: 100%;
    }
    
    .restaurant-hero-info h1 {
      font-size: 2.5rem;
    }
    
    .restaurant-meta {
      justify-content: center;
    }
    
    .restaurant-actions {
      flex-direction: column;
    }
    
    .details-grid {
      grid-template-columns: 1fr;
    }
    
    .photo-gallery, .related-restaurants {
      padding: 3rem 0;
    }
    
    .photo-gallery h2, .related-restaurants h2 {
      font-size: 2rem;
    }
  }
</style>
